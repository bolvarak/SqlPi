/////////////////////////////////////////////////////////////////////////////////////////
/// Headers ////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////

#include "Tcp.hpp"

/////////////////////////////////////////////////////////////////////////////////////////
/// SqlPi Namespace ////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////

namespace SqlPi
{
	/////////////////////////////////////////////////////////////////////////////////////
	/// SqlPi::Transport Namespace /////////////////////////////////////////////////////
	///////////////////////////////////////////////////////////////////////////////////

	namespace Transport
	{
		/////////////////////////////////////////////////////////////////////////////////
		/// Constructor ////////////////////////////////////////////////////////////////
		///////////////////////////////////////////////////////////////////////////////

		Tcp::Tcp()
		{
			// Instantiate the socket
			this->mConnection = new QTcpServer();
			// Make the new client connection
			this->connect(this->mConnection, SIGNAL(newConnection()), this, SLOT(client()));
		}

		/////////////////////////////////////////////////////////////////////////////////
		/// Public Abstract Implementations ////////////////////////////////////////////
		///////////////////////////////////////////////////////////////////////////////

		bool Tcp::await(QString &strError)
		{
			// Try to start the server
			if (!this->mConnection->listen(Process::Configuration::getBindAddress(), Process::Configuration::getBindPort())) {
				// Set the error
				strError = this->mConnection->errorString();
				// We're done, there was a problem starting the socket
				return false;
			}
			// We're done, all is well
			return true;
		}

		/////////////////////////////////////////////////////////////////////////////////
		/// Public Slot Abstract Implementations ///////////////////////////////////////
		///////////////////////////////////////////////////////////////////////////////

		void Tcp::client()
		{
			// Instantiate the new client
			Connection::Client* conClient = new Connection::Client(this);
			// Set the socket descriptor
			conClient->setSocket(this->mConnection->nextPendingConnection());
		}

		void Tcp::shutdown()
		{

		}

	/////////////////////////////////////////////////////////////////////////////////////
	} /// End SqlPi::Transport Namespace ///////////////////////////////////////////////
	///////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////
} /// End SqlPi Namespace //////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////
